---
title: axios çŸ¥è¦‹é›†(2017)
emoji: ğŸª“
type: tech
topics:
  - axios
  - javascript
published: true
---

::: message
ã“ã®è¨˜äº‹ã¯[axiosã‚’ä¹—ã‚Šã“ãªã™æ©Ÿèƒ½ã«ã¤ã„ã¦ã®çŸ¥è¦‹é›†](https://qiita.com/terrierscript/items/ccb56b6fc05aa7821c42)(2017/02)ã‹ã‚‰ç§»æ¤ã—ãŸã‚‚ã®ã§ã™
:::


requestå‡¦ç†ã‚’ã™ã‚‹ã¨ãã«ä½¿ã„å‹æ‰‹ãŒè‰¯ãã¦æ°—ã«ã£ã¦ã„ã‚‹[axios](https://github.com/mzabriskie/axios/)ã‚’ãã“ãã“ä½¿ã†ã‚ˆã†ã«ãªã£ã¦æºœã¾ã£ãŸçŸ¥è¦‹ã€‚

---

# 1. `adapter`ã‚’ä½¿ã£ã¦ç°¡æ˜“mocking

ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–¢é€£ã¯çµæ§‹ãƒ†ã‚¹ãƒˆãŒè¾›ããªã‚ŠãŒã¡ã€‚
ã“ã®ã‚ãŸã‚Šã‚’è§£æ±ºã™ã‚‹æ–¹æ³•ã¨ã—ã¦ã€[nock](https://github.com/node-nock/nock)ãªã©ãƒªã‚¯ã‚¨ã‚¹ãƒˆç³»ã‚’ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£åŒ–ã™ã‚‹ã®ãŒã‚ˆãã‚ã‚‹ãŒã€
axiosã®å ´åˆã€adapteræ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã¨mockã‚’ç°¡å˜ã«ã¤ãã‚Œã‚‹

```js
const axios = require('axios')

const mockData = [{
  id: 1,
  title: 'Some Article',
}]

const mockAdapter = (config) => {
  return new Promise((resolve, reject) => {
    resolve({data: mockData, status: 200 })
  })
}

axios.get('/some/url', {
  adapter: mockAdapter
}).then( response => {
  console.log(response.data) // mockData
  console.log(response.status) // 200
})
```

è‡ªå‰ã—ãŸããªã„å ´åˆã¯[moxios](https://github.com/mzabriskie/moxios)ã¨ã‹[axios-mock-adapter](https://github.com/ctimmerm/axios-mock-adapter)ã¨ã‹ã‚‚ã‚ã‚‹ã€‚


# 2. åŸºæœ¬configã‚’å›ºå®šã™ã‚‹ã‚„ã‚Šæ–¹ ( `axios.create()`, `axios.defaults`)

ä¾‹ãˆã°æ§˜ã€…ãªAPIã§åŒã˜ã‚ˆã†ãªè¨­å®šã‚’ã—ãŸã„ã“ã¨ãŒã‚ˆãã‚ã‚‹ã¨æ€ã†ã€‚

```js
axios.get('/some/url', { 
  xsrfHeaderName: 'X-CSRF-Token',
  withCredentials: true
})
axios.post('/some/other/url',{foo: 'bar'}, { 
  xsrfHeaderName: 'X-CSRF-Token',
  withCredentials: true
})
```

ã“ã®ã‚ˆã†ãªå ´åˆã«ã¯ã€[`axios.create()`](https://github.com/mzabriskie/axios#creating-an-instance)ã‚’åˆ©ç”¨ã—ã¦åˆ¥ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ã—ã¦ç”Ÿæˆã—ã¦ã—ã¾ã†ã®ãŒè‰¯ã„

```js
const myHttpClient = axios.create({ 
  xsrfHeaderName: 'X-CSRF-Token',
  withCredentials: true
})
myHttpClient.get('/some/url') // è¨­å®šãŒåæ˜ ã•ã‚Œã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãƒˆãƒ–
```

ã¾ãŸã€åˆ¥ãªæ–¹æ³•ã¨ã—ã¦ã€globalãªè¨­å®šã¨ã—ã¦[`defaults`](https://github.com/mzabriskie/axios#global-axios-defaults)ã§è¨­å®šã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã 

```js
axios.defaults.withCredentials = true
axios.defaults.xsrfHeaderName =  'X-CSRF-Token'
```

`timeout`ãªã©å…±é€šçš„ãªè¨­å®šã§ååˆ†ãªã‚‚ã®ã ã‘ã§æ¸ˆã‚€ãªã‚‰ä½¿ã£ã¦è‰¯ã•ãã†ã ã‚ã†ã€‚

defaultsæ©Ÿèƒ½ã¯axiosãŒå½±éŸ¿ã‚’å—ã‘ãŸangular1ã®`$http`ã«ç”±æ¥ã™ã‚‹ã‚‚ã®ã¨æ€ã‚ã‚Œã‚‹ã€‚
angularã®ã‚ˆã†ã«ã‚·ã‚¹ãƒ†ãƒ ã§ã²ã¨ã¾ã¨ã‚ã«ã™ã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ä¸Šã§ã¯éƒ½åˆãŒè‰¯ã„ã“ã¨ãŒå¤šã‹ã£ãŸã¨æƒ³åƒå‡ºæ¥ã‚‹ãŒã€`axios`ã§åˆ©ç”¨ã™ã‚‹ã‚·ãƒ¼ãƒ³ã¯ãã†ã§ã¯ãªã„å ´åˆãŒå¤šã„ã¨æƒ³åƒå‡ºæ¥ã‚‹ã®ã§ã€å€‹äººçš„ã«ã¯`axios.create`ã®ã»ã†ãŒãŠã™ã™ã‚ã§ãã‚‹

# 3. å‡¦ç†å·®ã—è¾¼ã¿

## 3-1. `interceptors`ã§å‡¦ç†å·®ã—è¾¼ã¿

ä¾‹ãˆã°[normalizr](https://github.com/paularmstrong/normalizr)ã¨ä½µç”¨ã—ã¦ã€APIçµæœã‚’å¤‰æ›ã—ãŸçŠ¶æ…‹ã«ã—ãŸã„ãªã‚‰ã“ã‚“ãªå…·åˆã«åˆ©ç”¨å‡ºæ¥ã‚‹ã€‚

```js
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ã™ã‚‹API
const userApi = axios.create()

userApi.interceptors.response.use( (response) => {
  response.data = normalize(res.data, article)
  // response.dataã‚’ä¸Šæ›¸ãã—ãŸããªã‘ã‚Œã°ã€ä¸‹è¨˜ã®ç”¨ã«ã—ã¦ã‚‚è‰¯ã„ã ã‚ã†
  // response.normalized = normalize(res.data, article)
  return res
})

userApi.get('/foo')
  .then( r => console.log(r.data)) // normalizedã—ãŸãƒ‡ãƒ¼ã‚¿ãŒå–ã‚Œã‚‹
```

interceptorã¯`request`,`response`ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã€‚
`use`ã¯è¤‡æ•°è¿½åŠ ã™ã‚‹ã“ã¨ã‚‚å‡ºæ¥ã‚‹ã®ã§ã€ä½•ã‹å‡¦ç†ã‚’ã‚ã‘ãŸã„ãªã‚‰ä¸‹è¨˜ã®ã‚ˆã†ã«ã‚‚æ›¸ã‘ã‚‹

```js
// request
userApi.interceptors.request.use( (config) => {
  // configã«ã¯é€ä¿¡å‰ã®dataã‚„urlã¨ã‹ãŒå…¥ã£ã¦ã„ã‚‹
    :
  return config
})

// response
userApi.interceptors.response.use( (response) => {
  /* å‡¦ç†ã²ã¨ã¤ã‚ */
    :
  return response
})
userApi.interceptors.response.use( (response) => {
  /* å‡¦ç†ãµãŸã¤ã‚ */
    :
  return response
})
```

ã¾ãŸã€`intercept`ã‚’ejectã™ã‚‹æ©Ÿèƒ½ã‚‚ç”¨æ„ã•ã‚Œã¦ã„ã‚‹

```js
var myInterceptor = axios.interceptors.request.use(function () {/*...*/});
axios.interceptors.request.eject(myInterceptor);
```

## 3-2. `transformResponse` / `transformRequest`ã§å‡¦ç†å·®ã—è¾¼ã¿

`transformResponse` / `transformRequest` ã¯ãã‚Œãã‚Œinterceptã‚ˆã‚Šã‚‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«è¿‘ã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å‡¦ç†ã•ã‚Œã‚‹ã€‚
`transformRequest`ã¯é€ä¿¡ã®å½¢å¼jsonä»¥å¤–ã®ç‰¹æ®Šãªå ´åˆãªã©ã«åˆ©ç”¨ã™ã‚‹ã¨è‰¯ã„ã ã‚ã†ã€‚

`transformResponse`ã¯ä¸»ã«æ–‡å­—åŒ–ã‘å¯¾ç­–ãªã©ã§åˆ©ç”¨ã§ãã‚‹

```js
// æ–‡å­—åŒ–ã‘å¯¾å‡¦ã®ä¾‹
axios(url, {
  responseType: "arraybuffer",
  transformResponse: [ (data) => {
    return iconv.convert(data, 'EUCJP', 'UTF8').toString()
  }]
})
```


## ãŠã¾ã‘ï¼šãã‚Œãã‚Œã©ã†ã„ã†é †åºã§è¡Œã‚ã‚Œã‚‹ã®ã‹æ¤œè¨¼ã™ã‚‹

ã“ã‚“ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã§èª¿ã¹ã‚‹

```js
const axios = require('axios')

const api = axios.create({
  adapter: function(config){
    console.log("adapter")
    return new Promise((resolve, reject) => {
      console.log("adapter(promise)")
      resolve({data: config.data})
    })
  },
  transformRequest: [(data, header) => {
    console.log("transformRequest")
    return data
  }],
  transformResponse: [(data) => {
    console.log("transformResponse")
    return data
  }]
})

api.interceptors.request.use((config) => {
  console.log("interceptors.request")
  return config
})
api.interceptors.response.use((response) => {
  console.log("interceptors.response")
  return response
})
api.post('/foo', { mock: "data"})
```

çµæœãŒã“ã¡ã‚‰

```
$ node axios-interceptor.js
interceptors.request
transformRequest
adapter
adapter(promise)
transformResponse
interceptors.response
```

`interceptor` => `transform` => `adapter`ã¨ã„ã†å½¢ã§å‡¦ç†ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹äº‹ãŒã‚ã‹ã‚‹ã€‚

# 4. è¤‡æ•°APIã®ä¸¦åˆ—å‡¦ç† (`axios.all`, `axios.spread`)

`axios.all`ã¨`spread`ã‚’åˆ©ç”¨ã—ã¦ä¸¦åˆ—å‡¦ç†ã«æ‰±ãˆã‚‹ã€‚

```js
const axios = require('axios')
const api = axios.create()

axios.all([
  api.get('/my/api'),
  api.get('/my/api2')
]).then( axios.spread( (api1Result, api2Result) => {
  //
})
```

ä½†ã—ã€`axios.all`ã¯`Promise.all`ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã€`axios.spread`ã¯é…åˆ—ã‚’å¼•æ•°åŒ–ã—ã¦ã„ã‚‹ã ã‘ãªã®ã§ã€ES2015ã®Destructuringæ§‹æ–‡ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã¨å®Ÿã¯ãã¡ã‚‰ã§ã‚‚ååˆ†å‡ºæ¥ã¦ã—ã¾ã†ã€‚

```js
const axios = require('axios')
const api = axios.create()

Promise.all([
  api.get('/my/api'),
  api.get('/my/api2')
]).then( ([api1Result, api2Result]) => {
  //
})
```

# ã¾ã¨ã‚
* è‰²ã€…ä½¿ã„æ–¹è¦šãˆã‚‹ã¨ã€çµæ§‹ä½¿ã„å‹æ‰‹ãŒå¤‰ã‚ã‚‹ã®ã§ã‚ªã‚¹ã‚¹ãƒ¡
    * ç‰¹ã«`axios.create`ã‚„`interceptors`ãªã©ã¯çµæ§‹é•ã†
* ãã®ä»–ã«ã‚‚[Cancel](https://github.com/mzabriskie/axios#cancellation)æ©Ÿèƒ½ã‚„ã‚‰[formå½¢å¼ã§ã®é€ä¿¡](https://github.com/mzabriskie/axios#using-applicationx-www-form-urlencoded-format)ãªã©çµæ§‹READMEã«è‰²ã€…æ›¸ã„ã¦ã‚ã‚‹
